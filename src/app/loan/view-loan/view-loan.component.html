<div
  *ngIf="data$ != null && !loading$"
  class="container-fluid h-100 overflow-auto p-3 bg-light"
>
  <div class="d-flex align-items-stretch gap-3">
    <!-- User Profile Section -->
    <div class="w-25 bg-white rounded shadow-sm p-3">
      <div class="d-flex flex-column align-items-center gap-0">
        <img
          [src]="data$.user?.profile ?? '../../../assets/profile.png'"
          class="rounded-circle border"
          width="80"
          height="80"
        />

        <h6 class="fw-bold text-primary">
          {{ data$.user?.lastName }} {{ data$.user?.firstName }}
          {{ data$.user?.middleName }}
        </h6>
        <p class="text-muted">
          {{ data$.loanAccount?.address }}
        </p>
        <p class="text-muted fw-bold text-dark">
          Credit Score : {{ data$.loanAccount?.creditScore }}
        </p>
        <p class="text-muted">{{ data$.user?.username }}</p>
        <p class="mt-2 mb-0">
          <strong class="text-dark">Available Loan:</strong>
          <span class="text-success fw-bold">{{
            data$.loanAccount?.amount | currency : "PHP"
          }}</span>
        </p>
      </div>
    </div>

    <div class="flex-grow-1 bg-white rounded p-3">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="fw-bold text-dark">Active Loans</h5>
        <div class="d-flex gap-3">
          <button
            class="btn btn-dark"
            *ngIf="user$?.type === 'ADMIN'"
            (click)="increaseLimit(data$.loanAccount, user$)"
          >
            Increase Limit
          </button>
          <button
            [disabled]="data$.loanAccount?.amount === 0"
            class="btn btn-primary px-4"
            (click)="createLoan(data$.user!!, data$.loanAccount!)"
          >
            Make a Loan
          </button>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-md-6" *ngFor="let loan of activeLoans$">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <div class="row">
                <div class="col-6">
                  <small class="text-muted">Loan ID</small>
                  <h6 class="fw-bold">{{ loan.id }}</h6>
                </div>
                <div class="col-6">
                  <small class="text-muted">Amount</small>
                  <h6 class="fw-bold text-success">
                    {{ loan.amount | currency : "PHP" }}
                  </h6>
                </div>
                <div class="col-6">
                  <small class="text-muted">Interest</small>
                  <h6>{{ loan.interest }}%</h6>
                </div>
                <div class="col-6">
                  <small class="text-muted">Amount Paid</small>
                  <h6 class="text-info">
                    {{ loan.amountPaid | currency : "PHP" }}
                  </h6>
                </div>
                <div class="col-6 mt-3">
                  <button
                    class="btn btn-primary btn-sm"
                    (click)="createPdf(loan)"
                  >
                    Download
                  </button>
                </div>
                <div class="col-6 mt-3">
                  <small class="text-muted">Remaining Balance </small>
                  <h6 class="text-danger">
                    {{ loan.amount - loan.amountPaid | currency : "PHP" }}
                  </h6>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab Navigation -->
      <ul ngbNav #nav="ngbNav" [(activeId)]="active" class="nav nav-tabs mt-4">
        <li [ngbNavItem]="1">
          <button ngbNavLink class="nav-link">Payment Schedule</button>
          <ng-template ngbNavContent>
            <table class="table table-hover mt-3">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let payment of payments">
                  <td>{{ payment.date }}</td>
                  <td>{{ payment.amount }}</td>
                  <td>
                    <span
                      class="badge"
                      [ngClass]="{
                        'bg-success': payment.status === 'PAID',
                        'bg-warning': payment.status === 'UNPAID',
                        'bg-danger': payment.status === 'OVERDUE'
                      }"
                    >
                      {{ payment.status }}
                    </span>
                  </td>
                </tr>
                <tr *ngIf="payments.length === 0">
                  <td colspan="3" class="text-center text-muted">
                    No payments found.
                  </td>
                </tr>
              </tbody>
            </table>
          </ng-template>
        </li>

        <li [ngbNavItem]="2">
          <button ngbNavLink class="nav-link">Loans</button>
          <ng-template ngbNavContent>
            <table class="table table-striped table-hover">
              <thead class="thead-dark">
                <tr>
                  <th scope="col">Loan ID</th>
                  <th scope="col">Account ID</th>
                  <th scope="col">Amount</th>
                  <th scope="col">Interest (%)</th>
                  <th scope="col">Amount Paid</th>
                  <th scope="col">Status</th>
                  <th scope="col">Created At</th>
                  <th scope="col">Updated At</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let loan of loans$" (click)="createPdf(loan)">
                  <td>{{ loan.id }}</td>
                  <td>{{ loan.loanAccountID }}</td>
                  <td>{{ loan.amount | currency : "PHP" }}</td>
                  <td>{{ loan.interest }}</td>
                  <td>{{ loan.amountPaid | currency : "PHP" }}</td>
                  <td>
                    <span
                      [ngClass]="{
                        'badge badge-success': loan.status === 'PAID',
                        'badge badge-warning': loan.status === 'PENDING',
                        'badge badge-danger': loan.status === 'DECLINED'
                      }"
                    >
                      {{ loan.status }}
                    </span>
                  </td>
                  <td>{{ loan.createdAt | date : "MMM dd, yyyy" }}</td>
                  <td>{{ loan.updatedAt | date : "MMM dd, yyyy" }}</td>
                </tr>
              </tbody>
            </table>
          </ng-template>
        </li>
        <li [ngbNavItem]="3">
          <button ngbNavLink class="nav-link">Loan History</button>
          <ng-template ngbNavContent>
            <ul class="list-group mt-3">
              <li
                class="list-group-item d-flex justify-content-between align-items-center"
                *ngFor="let history of histories$ | async"
              >
                <div>
                  <p class="mb-1 text-dark fw-bold">{{ history.message }}</p>
                  <small class="text-muted">{{
                    history.createdAt | date : "long"
                  }}</small>
                </div>
                <span class="fw-bold text-primary">{{
                  history.amount | currency : "PHP"
                }}</span>
              </li>
            </ul>
          </ng-template>
        </li>

        <li [ngbNavItem]="4">
          <button ngbNavLink class="nav-link">Documents</button>
          <ng-template ngbNavContent>
            <div class="row g-3 p-3">
              <div class="col">
                <img
                  [src]="data$.document?.first_id"
                  width="200"
                  height="200"
                  alt="idsz"
                  class="rounded-3"
                />
              </div>
              <div class="col">
                <img
                  [src]="data$.document?.secound_id"
                  width="200"
                  height="200"
                  alt="idsz"
                  class="rounded-3"
                />
              </div>

              <div class="col">
                <img
                  [src]="data$.document?.third_id"
                  width="200"
                  height="200"
                  alt="idsz"
                  class="rounded-3"
                />
              </div>

              <div class="col">
                <img
                  [src]="data$.document?.gov_id"
                  width="200"
                  height="200"
                  alt="idsz"
                  class="rounded-3"
                />
              </div>

              <div class="col">
                <img
                  [src]="data$.document?.barangay_permit"
                  width="200"
                  height="200"
                  alt="idsz"
                  class="rounded-3"
                />
              </div>

              <div class="col">
                <img
                  [src]="data$.document?.omeco_bill"
                  width="200"
                  height="200"
                  alt="idsz"
                  class="rounded-3"
                />
              </div>

              <div class="col">
                <img
                  [src]="data$.document?.cedula"
                  width="200"
                  height="200"
                  alt="idsz"
                  class="rounded-3"
                />
              </div>
            </div>
          </ng-template>
        </li>
      </ul>
      <div [ngbNavOutlet]="nav" class="mt-3"></div>
    </div>
  </div>
</div>

<!-- Loading State -->
<div
  *ngIf="loading$"
  class="d-flex flex-column justify-content-center align-items-center h-100"
>
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <h5 class="mt-3 text-primary">Getting loan account data...</h5>
</div>
t
<!-- No Data State -->
<div
  *ngIf="data$ == null && !loading$"
  class="d-flex justify-content-center align-items-center h-100"
>
  <h5 class="text-muted">Loan data not found!</h5>
</div>
